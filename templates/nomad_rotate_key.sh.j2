#!/usr/bin/env bash


echo "==========BEGIN GOSSIP KEY ROTATION=========="

# Setup Consul address info
export NOMAD_ADDR="https://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:4646"

# The new key will be in a file generated by consul-template
# the script retrieves the key from the file
NEW_KEY=`cat /opt/nomad/templates/gossip.key | sed -e 's/\r$//'`

# Install the key
nomad operator gossip keyring install ${NEW_KEY}

# Set as primary
nomad operator gossip keyring use ${NEW_KEY}

# Retrieve all keys used by Consul

KEYS=`nomad operator gossip keyring list | tail -n +3 | sort | uniq`

for i in `echo $KEYS`; do
  if [ $i != ${NEW_KEY} ]; then
    echo "==> Will try to remove old encryption keys or fail safely..."
    nomad operator gossip keyring remove $i
  fi
done


echo "==> Writing next gossip encryption key to vault..."

curl  --header "X-Vault-Token: {{ nomad_rotation_token }}" --request POST --data "{\"key\": \"$(nomad operator gossip keyring generate)\", \"ttl\": \"{{ consul_template_gossip_key_ttl }}\"}" -k  {{ global_vault_address }}/v1/hashistack/kv/nomad_gossip_key

echo "==> Done at $(date). Waiting for next ttl."


echo "==========END GOSSIP KEY ROTATION=========="
