#!/usr/bin/env bash


echo "==========BEGIN GOSSIP KEY ROTATION=========="

# Setup Consul address info
export NOMAD_HTTP_ADDR="http://nomad.service.consul:4646"

# The new key will be in a file generated by consul-template
# the script retrieves the key from the file
NEW_KEY=`cat /opt/nomad/templates/gossip.key | sed -e '/^$/d'`

# Install the key
nomad operator keyring -install ${NEW_KEY}

# Set as primary
nomad operator keyring -use ${NEW_KEY}

# Retrieve all keys used by Consul

KEYS=`nomad operator keyring -list | tail -n +3 | sort | uniq`

for i in `echo $KEYS`; do
  if [ $i != ${NEW_KEY} ]; then
    nomad operator keyring -remove $i
  fi
done


echo "==> Writing next gossip encryption key to vault..."

curl  --header "X-Vault-Token: {{ nomad_gossip_token }}" --header "X-Vault-Namespace: admin" --request POST --data "{\"key\": \"$(nomad operator keygen)\", \"ttl\": \"{{ consul_template_gossip_key_ttl }}\"}" -k  {{ hcp_vault_address }}/v1/gitlab/kv/nomad_gossip_key

echo "==> Done at $(date). Waiting for next ttl."


echo "==========END GOSSIP KEY ROTATION=========="
